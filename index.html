<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PepeChan - –ò–º–∏–¥–∂–±–æ—Ä–¥ (Admin Update)</title>
    <style>
        /* --- CSS Reset & Basics --- */
        * { box-sizing: border-box; }
        body {
            margin: 0;
            padding: 0;
            background-color: #f0f8f0;
            color: #003300;
            font-family: Arial, Helvetica, sans-serif;
            font-size: 13px;
        }
        a { color: #005500; text-decoration: none; cursor: pointer; font-weight: bold;}
        a:hover { color: #00aa00; text-decoration: underline; }
        
        /* --- Layout --- */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
        }

        /* --- Header & Nav --- */
        #board-nav {
            padding: 5px;
            border-bottom: 1px solid #aaccaa;
            margin-bottom: 10px;
            background: #d1e8d1;
            font-size: 14px;
        }
        #board-nav span { margin: 0 5px; }
        
        .logo {
            text-align: center;
            margin: 20px 0 10px 0;
        }
        .logo h1 {
            color: #2e7d32;
            margin: 0;
            font-size: 28px;
            font-weight: bold;
            text-shadow: 1px 1px 0 #fff;
        }
        .logo .subtitle {
            font-size: 16px;
            color: #446644;
        }
        .logo-img {
            font-size: 40px;
            display: inline-block;
            margin-bottom: 5px;
            cursor: help; /* Hint for interaction */
            user-select: none;
        }
        .logo-img:active { transform: scale(0.9); }

        /* --- Announcement --- */
        #global-announcement {
            text-align: center;
            color: #d32f2f;
            font-weight: bold;
            margin: 10px auto;
            padding: 5px;
            border: 1px dashed #d32f2f;
            background: #fff0f0;
            max-width: 800px;
            display: none; /* Hidden if empty */
        }
        .announcement-edit-btn {
            font-size: 10px;
            cursor: pointer;
            color: blue;
            margin-left: 5px;
        }

        /* --- Forms --- */
        .post-form-container {
            background-color: #d1e8d1;
            border: 1px solid #aaccaa;
            width: 100%;
            max-width: 500px;
            margin: 0 auto 20px auto;
            padding: 10px;
            display: table;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.05);
        }
        
        .form-row { margin-bottom: 4px; display: flex; align-items: center; flex-wrap: wrap;}
        .form-label {
            background: #a5d6a7;
            color: #003300;
            font-weight: bold;
            padding: 2px 5px;
            width: 100px;
            font-size: 11px;
            border: 1px solid #81c784;
            margin-right: 5px;
            flex-shrink: 0;
        }
        .form-input { flex-grow: 1; padding: 2px; border: 1px solid #81c784; font-size: 12px; }
        textarea.form-input { height: 100px; resize: vertical; width: 100%; }
        
        button.submit-btn {
            background: #fff;
            border: 1px solid #66bb6a;
            color: #2e7d32;
            cursor: pointer;
            padding: 2px 8px;
            font-weight: bold;
        }
        button.submit-btn:hover {
            background: #e8f5e9;
        }
        
        .file-upload-wrapper {
            display: flex;
            align-items: center;
            width: 100%;
            margin-top: 2px;
        }
        .file-upload-or { margin: 0 5px; font-size: 10px; color: #555; }

        /* Admin Controls in Form */
        #admin-posting-options {
            background: #ffe0b2;
            padding: 3px;
            border: 1px solid #ffcc80;
            margin-bottom: 5px;
            font-size: 11px;
            display: none;
        }

        /* --- Threads & Posts --- */
        .thread { margin-bottom: 40px; border-bottom: 1px solid #aaccaa; padding-bottom: 20px; clear: both;}
        
        .post {
            overflow: hidden;
            margin-bottom: 4px;
        }
        
        /* OP Post Style */
        .op-post {
            display: block;
        }

        /* Reply Style */
        .reply-container {
            display: table;
            background-color: #e0f2e0;
            border: 1px solid #b2dfdb;
            margin: 2px 0;
            padding: 5px;
            min-width: 400px;
            max-width: 100%;
            border-radius: 2px;
        }

        .post-header {
            font-size: 12px;
            margin-bottom: 5px;
            color: #555;
        }
        .subject { color: #1b5e20; font-weight: bold; }
        .name { color: #2e7d32; font-weight: bold; }
        .trip { color: #228854; font-weight: normal; }
        .date { color: #446644; }
        .id { color: #446644; cursor: pointer;}
        .post-number { color: #446644; cursor: pointer; }
        
        /* Special Post States */
        .pinned-icon { color: #d32f2f; font-weight: bold; margin-right: 5px; }
        .locked-icon { color: #d32f2f; font-weight: bold; margin-right: 5px; }
        
        /* Admin Styles */
        .admin-capcode {
            color: #ff0000 !important;
            font-weight: bold;
        }
        .admin-btn {
            cursor: pointer;
            font-weight: bold;
            margin-left: 5px;
            font-size: 10px;
            padding: 0 2px;
            border: 1px solid transparent;
        }
        .btn-del { color: red; }
        .btn-pin { color: blue; }
        .btn-lock { color: orange; }
        .admin-btn:hover { border: 1px solid #aaa; background: #eee; }

        .admin-panel-indicator {
            background: red;
            color: white;
            padding: 2px 5px;
            font-size: 10px;
            font-weight: bold;
            display: none; 
        }
        .admin-meta-info {
            font-size: 10px;
            font-family: monospace;
            background: #333;
            color: #fff;
            padding: 1px 4px;
            margin-left: 5px;
            border-radius: 3px;
        }

        .file-info {
            font-size: 11px;
            margin-bottom: 2px;
            color: #557755;
        }

        .post-image {
            float: left;
            margin: 0 20px 5px 0;
            max-width: 250px;
            max-height: 250px;
            cursor: pointer;
            border: 1px solid #aaccaa;
        }
        .post-image.expanded {
            max-width: 90%;
            max-height: 90vh;
        }

        .post-message {
            margin: 10px 0;
            font-size: 14px;
            line-height: 1.4;
            word-wrap: break-word;
            white-space: pre-wrap;
            color: #002200;
        }

        .greentext { color: #558b2f; font-weight: bold; }
        .error-msg { color: #d32f2f; text-align: center; margin: 10px; font-weight: bold; }
        .loading-msg { color: #2e7d32; text-align: center; margin: 20px; font-weight: bold; font-style: italic;}
        .warning-bar { background: #ffebee; color: #b71c1c; padding: 10px; text-align: center; font-size: 13px; border-bottom: 1px solid #ef9a9a; font-weight: bold; }
        
        .nav-links { margin-bottom: 10px; }
        
        footer {
            margin-top: 50px;
            text-align: center;
            font-size: 10px;
            color: #88aa88;
            padding-bottom: 20px;
        }
        
        .status-indicator {
            display: inline-block;
            margin-right: 10px;
            font-weight: bold;
        }
        .status-online { color: #2e7d32; }
        .status-offline { color: #d32f2f; }

        /* --- Modal Styles --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-box {
            background: #f0f8f0;
            border: 1px solid #2e7d32;
            padding: 20px;
            width: 300px;
            text-align: center;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .modal-input { width: 100%; padding: 5px; margin: 10px 0; border: 1px solid #81c784; }
        .modal-btn { background: #2e7d32; color: white; border: none; padding: 5px 15px; cursor: pointer; margin: 5px; }
        .modal-btn.close { background: #d32f2f; }

        @media (max-width: 600px) {
            .reply-container { min-width: 0; width: 100%; }
            .post-image { max-width: 150px; }
            .form-label { width: 70px; }
            .container { padding: 5px; }
        }
    </style>
</head>
<body>

<!-- Login Modal -->
<div id="login-modal" class="modal-overlay">
    <div class="modal-box">
        <h3>Admin Access</h3>
        <input type="password" id="admin-pass-input" class="modal-input" placeholder="Password">
        <button id="modal-login-btn" class="modal-btn">–í–æ–π—Ç–∏</button>
        <button id="modal-close-btn" class="modal-btn close">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

<!-- Navigation -->
<div id="board-nav">
    [ 
    <a href="#" onclick="window.app.switchBoard('b')">b</a> / 
    <a href="#" onclick="window.app.switchBoard('a')">a</a> /
    <a href="#" onclick="window.app.switchBoard('mu')">mu</a> /
    <a href="#" onclick="window.app.switchBoard('vg')">vg</a> / 
    <a href="#" onclick="window.app.switchBoard('gd')">gd</a> /
    <a href="#" onclick="window.app.switchBoard('fit')">fit</a> /
    <a href="#" onclick="window.app.switchBoard('po')">po</a> / 
    <a href="#" onclick="window.app.switchBoard('s')">s</a> /
    <a href="#" onclick="window.app.switchBoard('sci')">sci</a>
    ]
    <span style="float:right">
        <span id="admin-indicator" class="admin-panel-indicator">ADMIN MODE</span>
        <a href="#" id="toggle-ids-btn" style="display:none; font-size:10px; margin-right:10px;" onclick="window.app.toggleAdminView()">[–ü–æ–∫–∞–∑–∞—Ç—å ID/IP]</a>
        [ <a href="#" onclick="window.app.setLanguage('ru')">RU</a> / <a href="#" onclick="window.app.setLanguage('en')">EN</a> ]
    </span>
</div>

<div class="container">
    <div id="config-warning" class="warning-bar" style="display:none;"></div>

    <!-- Header -->
    <div class="logo">
        <span class="logo-img" id="frog-logo" title="Ribbit?">üê∏</span>
        <h1 id="board-title">/b/ - –ë—Ä–µ–¥</h1>
        
        <!-- Announcement Area -->
        <div id="global-announcement">
            <span id="announcement-text"></span>
            <span id="announcement-edit" class="announcement-edit-btn" style="display:none" onclick="window.app.editAnnouncement()">[Edit]</span>
        </div>

        <div class="subtitle" id="board-subtitle">Feels good man</div>
    </div>

    <!-- Creation Form -->
    <div class="post-form-container" id="post-form">
        <div id="form-type-label" style="text-align: center; font-weight: bold; margin-bottom: 5px; color: #1b5e20;">–ù–æ–≤—ã–π —Ç—Ä–µ–¥</div>
        
        <!-- Admin Options -->
        <div id="admin-posting-options">
            <label>
                <input type="checkbox" id="admin-post-as-admin" onchange="window.app.updateNamePlaceholder()"> 
                –ü–æ—Å—Ç–∏—Ç—å –∫–∞–∫ Admin
            </label>
        </div>

        <div class="form-row">
            <div class="form-label" id="lbl-name">–ò–º—è</div>
            <input type="text" id="input-name" class="form-input" placeholder="–ê–Ω–æ–Ω–∏–º">
        </div>
        <div class="form-row">
            <div class="form-label" id="lbl-subject">–¢–µ–º–∞</div>
            <input type="text" id="input-subject" class="form-input">
            <button class="submit-btn" id="btn-submit" onclick="window.app.submitPost()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
        <div class="form-row">
            <div class="form-label" id="lbl-comment">–¢–µ–∫—Å—Ç</div>
            <textarea id="input-comment" class="form-input"></textarea>
        </div>
        <div class="form-row">
            <div class="form-label" id="lbl-file">–ö–∞—Ä—Ç–∏–Ω–∫–∞</div>
            <div class="file-upload-wrapper">
                <input type="text" id="input-file" class="form-input" placeholder="URL (https://...)" style="flex-grow:1;">
                <span class="file-upload-or">–∏–ª–∏</span>
                <input type="file" id="input-file-upload" accept="image/*" class="form-input" style="width: 180px;">
            </div>
        </div>
    </div>
    
    <div class="nav-links" id="nav-links" style="display:none;">
        <hr>
        [ <a href="#" onclick="window.app.goCatalog()" id="link-catalog">–ù–∞–∑–∞–¥ –≤ –∫–∞—Ç–∞–ª–æ–≥</a> ]
        <hr>
    </div>

    <!-- Dynamic Content Area -->
    <div id="main-content">
        <div class="loading-msg" id="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–¥–∫–∏—Ö –ø–µ–ø–µ...</div>
    </div>

    <footer>
        <span id="status-display" class="status-indicator">Status: Connecting...</span>
        PepeChan Engine v2.5
    </footer>

</div>

<!-- Firebase Logic -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, deleteDoc, updateDoc, setDoc, doc, onSnapshot, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- –ù–ê–°–¢–†–û–ô–ö–ò FIREBASE (–î–õ–Ø –•–û–°–¢–ò–ù–ì–ê) ---
    const manualConfig = {
        apiKey: "AIzaSyD0drXAAP2LQSbHloYq2YUIaw4YS-mKv-Y",
        authDomain: "pepechan-board.firebaseapp.com",
        projectId: "pepechan-board",
        storageBucket: "pepechan-board.firebasestorage.app",
        messagingSenderId: "805918011698",
        appId: "1:805918011698:web:2c8fa7ba6e76cf9648672b"
    };
    // ------------------------------------------

    let app, auth, db, appId;
    let useLocalStorage = false; 

    // Hash Password (SHA-256)
    // basedpepe -> d36440c9504812f8646b40285223c2d46e33620023641773091217088d305615
    const ADMIN_HASH = "d36440c9504812f8646b40285223c2d46e33620023641773091217088d305615";

    const updateStatus = (isOnline, msg) => {
        const el = document.getElementById('status-display');
        if (isOnline) {
            el.textContent = "Status: Online";
            el.className = "status-indicator status-online";
        } else {
            el.textContent = "Status: Offline (Local)" + (msg ? ` - ${msg}` : "");
            el.className = "status-indicator status-offline";
        }
    };

    try {
        let configToUse;
        if (typeof __firebase_config !== 'undefined') {
             configToUse = JSON.parse(__firebase_config);
             appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        } else if (manualConfig.apiKey && manualConfig.apiKey.length > 5) {
             configToUse = manualConfig;
             appId = 'pepechan-public-v1'; 
        } else {
            throw new Error("Missing config");
        }

        app = initializeApp(configToUse);
        auth = getAuth(app);
        db = getFirestore(app);

    } catch (e) {
        console.warn("Firebase Config Error.", e);
        useLocalStorage = true;
        updateStatus(false, "Config Missing");
        const warn = document.getElementById('config-warning');
        warn.style.display = 'block';
        warn.innerHTML = "<b>–†–ï–ñ–ò–ú –û–§–õ–ê–ô–ù (Local Storage).</b><br>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ <code>manualConfig</code> –≤ —Ñ–∞–π–ª–µ.";
    }

    // --- Translations ---
    const TRANSLATIONS = {
        ru: {
            nav_title: "PepeChan Online", new_thread: "–ù–æ–≤—ã–π —Ç—Ä–µ–¥", reply_to: "–û—Ç–≤–µ—Ç –≤ —Ç—Ä–µ–¥ ‚Ññ", name: "–ò–º—è", subject: "–¢–µ–º–∞", submit: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å", comment: "–¢–µ–∫—Å—Ç", image_url: "–ö–∞—Ä—Ç–∏–Ω–∫–∞", anon: "–ê–Ω–æ–Ω–∏–º", back_catalog: "–ù–∞–∑–∞–¥ –≤ –∫–∞—Ç–∞–ª–æ–≥", loading: "–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–¥–∫–∏—Ö –ø–µ–ø–µ...", empty_board: "–î–æ—Å–∫–∞ –ø—É—Å—Ç–∞. –°–∞–¥–∂–µ–º. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π —Ç—Ä–µ–¥!", omitted: "–ü—Ä–æ–ø—É—â–µ–Ω–æ –æ—Ç–≤–µ—Ç–æ–≤", click_reply: "–ù–∞–∂–º–∏—Ç–µ \"–û—Ç–≤–µ—Ç\" —á—Ç–æ–±—ã —á–∏—Ç–∞—Ç—å –≤—Å—ë.", thread_not_found: "–¢—Ä–µ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω (–∏–ª–∏ —É–¥–∞–ª–µ–Ω).", file: "–§–∞–π–ª", link: "–°—Å—ã–ª–∫–∞", reply_btn: "–û—Ç–≤–µ—Ç", error_conn: "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É", error_load: "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö", wait_conn: "–ü–æ–¥–æ–∂–¥–∏—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º...", validation_err: "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.", error_send: "–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ—Å—Ç–∞", name_banned: "–≠—Ç–æ –∏–º—è –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ.", admin_fail: "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å.", admin_success: "–†–µ–∂–∏–º –±–æ–≥–∞ –≤–∫–ª—é—á–µ–Ω.", admin_logout: "–†–µ–∂–∏–º –±–æ–≥–∞ –≤—ã–∫–ª—é—á–µ–Ω.", delete_confirm: "–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç?", board_b_desc: "–ë—Ä–µ–¥", board_a_desc: "–ê–Ω–∏–º–µ", board_mu_desc: "–ú—É–∑—ã–∫–∞", board_vg_desc: "–í–∏–¥–µ–æ–∏–≥—Ä—ã", board_gd_desc: "–î–∏–∑–∞–π–Ω", board_fit_desc: "–§–∏—Ç–Ω–µ—Å", board_po_desc: "–ü–æ–ª–∏—Ç–∏–∫–∞", board_s_desc: "–ü—Ä–æ–≥—Ä–∞–º–º—ã", board_sci_desc: "–ù–∞—É–∫–∞", feels_good: "Feels good man", thread_locked: "–¢—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç."
        },
        en: {
            nav_title: "PepeChan Online", new_thread: "New Thread", reply_to: "Reply to Thread #", name: "Name", subject: "Subject", submit: "Submit", comment: "Comment", image_url: "Image", anon: "Anonymous", back_catalog: "Return to Catalog", loading: "Loading rare pepes...", empty_board: "Board is empty. Sadge. Create the first thread!", omitted: "Replies omitted", click_reply: "Click \"Reply\" to view.", thread_not_found: "Thread not found (or deleted).", file: "File", link: "Link", reply_btn: "Reply", error_conn: "Connection error", error_load: "Error loading data", wait_conn: "Waiting for server connection...", validation_err: "Please enter text or attach an image.", error_send: "Error sending post", name_banned: "Reserved name.", admin_fail: "Wrong password.", admin_success: "God mode enabled.", admin_logout: "God mode disabled.", delete_confirm: "Delete this post?", board_b_desc: "Random", board_a_desc: "Anime", board_mu_desc: "Music", board_gd_desc: "Graphic Design", board_fit_desc: "Fitness", board_vg_desc: "Video Games", board_po_desc: "Politics", board_s_desc: "Software", board_sci_desc: "Science", feels_good: "Feels good man", thread_locked: "Thread locked."
        }
    };

    const BOARDS = { 'b': 'board_b_desc', 'a': 'board_a_desc', 'mu': 'board_mu_desc', 'vg': 'board_vg_desc', 'gd': 'board_gd_desc', 'fit': 'board_fit_desc', 'po': 'board_po_desc', 's': 'board_s_desc', 'sci': 'board_sci_desc' };
    const BANNED_NAMES = /^(admin|administrator|mod|moderator|root|moot|pepechan)$/i;

    class ImageboardApp {
        constructor() {
            this.currentBoard = 'b';
            this.view = 'catalog';
            this.currentThreadId = null;
            this.user = null;
            this.posts = []; 
            this.announcement = "";
            this.loading = true;
            this.isAdminMode = false;
            this.showAdminMeta = false;
            this.logoClicks = 0;
            
            this.lang = localStorage.getItem('pepechan_lang') || 'ru';

            this.setupModal();
            this.setupLogoTrigger();

            if (!useLocalStorage && auth) {
                this.initAuth();
            } else {
                this.startListener();
            }
            this.updateInterface(); 
        }
        
        async sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        setupLogoTrigger() {
            const frog = document.getElementById('frog-logo');
            frog.addEventListener('click', () => {
                this.logoClicks++;
                if (this.logoClicks >= 10) {
                    this.logoClicks = 0;
                    this.openLoginModal();
                }
                // Reset counter if idle
                clearTimeout(this.clickTimer);
                this.clickTimer = setTimeout(() => { this.logoClicks = 0; }, 2000);
            });
        }

        openLoginModal() {
            if (this.isAdminMode) {
                this.isAdminMode = false;
                this.showAdminMeta = false;
                alert(this.t('admin_logout'));
                this.updateInterface();
                this.render();
            } else {
                document.getElementById('login-modal').style.display = 'flex';
                document.getElementById('admin-pass-input').value = '';
                document.getElementById('admin-pass-input').focus();
            }
        }

        setupModal() {
            const modal = document.getElementById('login-modal');
            const closeBtn = document.getElementById('modal-close-btn');
            const loginBtn = document.getElementById('modal-login-btn');
            const input = document.getElementById('admin-pass-input');

            closeBtn.addEventListener('click', () => { modal.style.display = 'none'; });

            const attemptLogin = async () => {
                const pass = input.value.trim().toLowerCase(); // Normalize
                try {
                    const inputHash = await this.sha256(pass);
                    if (inputHash === ADMIN_HASH) {
                        this.isAdminMode = true;
                        alert(this.t('admin_success'));
                        this.updateInterface();
                        this.render();
                        modal.style.display = 'none';
                    } else {
                        alert(this.t('admin_fail'));
                    }
                } catch (e) {
                    alert("–û—à–∏–±–∫–∞ –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–Ω—É–∂–µ–Ω HTTPS/Localhost)");
                }
            };

            loginBtn.addEventListener('click', attemptLogin);
            input.addEventListener('keypress', (e) => { if (e.key === 'Enter') attemptLogin(); });
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });
        }

        t(key) { return TRANSLATIONS[this.lang][key] || key; }
        setLanguage(lang) { this.lang = lang; localStorage.setItem('pepechan_lang', lang); this.updateInterface(); this.render(); }

        updateInterface() {
            document.getElementById('lbl-name').textContent = this.t('name');
            document.getElementById('lbl-subject').textContent = this.t('subject');
            document.getElementById('lbl-comment').textContent = this.t('comment');
            document.getElementById('lbl-file').textContent = this.t('image_url');
            document.getElementById('btn-submit').textContent = this.t('submit');
            document.getElementById('link-catalog').textContent = this.t('back_catalog');
            this.updateNamePlaceholder();
            document.querySelector('.logo .subtitle').textContent = this.t('feels_good');
            
            const indicator = document.getElementById('admin-indicator');
            indicator.style.display = this.isAdminMode ? 'inline-block' : 'none';
            
            const metaBtn = document.getElementById('toggle-ids-btn');
            metaBtn.style.display = this.isAdminMode ? 'inline-block' : 'none';
            
            const adminOpts = document.getElementById('admin-posting-options');
            adminOpts.style.display = this.isAdminMode ? 'block' : 'none';
            
            const editAnnounce = document.getElementById('announcement-edit');
            editAnnounce.style.display = this.isAdminMode ? 'inline' : 'none';

            const bInfo = BOARDS[this.currentBoard];
            document.getElementById('board-title').textContent = `/${this.currentBoard}/ - ${this.t(bInfo)}`;
        }
        
        updateNamePlaceholder() {
            const isAdminPost = document.getElementById('admin-post-as-admin')?.checked;
            const ph = (this.isAdminMode && isAdminPost) ? "Admin" : this.t('anon');
            document.getElementById('input-name').placeholder = ph;
        }
        
        toggleAdminView() {
            this.showAdminMeta = !this.showAdminMeta;
            this.render();
        }

        async initAuth() {
            onAuthStateChanged(auth, (user) => {
                if (user) { this.user = user; this.startListener(); }
            });
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                else await signInAnonymously(auth);
            } catch (error) {
                console.error("Auth Error:", error);
                useLocalStorage = true;
                updateStatus(false, "Auth Error");
                const warn = document.getElementById('config-warning');
                warn.style.display = 'block';
                warn.innerHTML = `–û–®–ò–ë–ö–ê –í–•–û–î–ê: –í–∫–ª—é—á–∏—Ç–µ <b>Anonymous</b> –≤ –∫–æ–Ω—Å–æ–ª–∏ Firebase. –û—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º.`;
                this.startListener();
            }
        }

        startListener() {
            if (useLocalStorage) {
                this.posts = JSON.parse(localStorage.getItem('pepechan_posts_v2')) || [];
                this.loading = false;
                this.render();
                return;
            }
            if (!db) return;
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'nanochan_posts'));
            
            onSnapshot(q, (snapshot) => {
                const newPosts = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // Handle Announcement Doc Separately
                    if (doc.id === 'ANNOUNCEMENT') {
                        this.announcement = data.text || "";
                        this.renderAnnouncement();
                    } else {
                        newPosts.push({ _docId: doc.id, ...data });
                    }
                });
                this.posts = newPosts;
                this.loading = false;
                updateStatus(true);
                this.render();
            }, (error) => {
                useLocalStorage = true; 
                updateStatus(false, "DB Error");
                const warn = document.getElementById('config-warning');
                warn.style.display = 'block';
                warn.innerHTML = `–û–®–ò–ë–ö–ê –ë–ê–ó–´: –í–∫–ª—é—á–∏—Ç–µ <b>Rules</b> (read/write = true). –û—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º.`;
                this.startListener();
            });
        }
        
        renderAnnouncement() {
            const div = document.getElementById('global-announcement');
            const text = document.getElementById('announcement-text');
            if (this.announcement) {
                div.style.display = 'block';
                text.textContent = this.announcement;
            } else {
                div.style.display = this.isAdminMode ? 'block' : 'none'; // Admin sees empty box to edit
                text.textContent = this.isAdminMode ? "[–ù–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π]" : "";
            }
        }
        
        async editAnnouncement() {
            const newText = prompt("–¢–µ–∫—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è):", this.announcement);
            if (newText === null) return;
            
            if (useLocalStorage) {
                alert("–û–±—ä—è–≤–ª–µ–Ω–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç –≤ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º–µ.");
                return;
            }
            
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'nanochan_posts', 'ANNOUNCEMENT'), { text: newText });
            } catch(e) {
                alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + e.message);
            }
        }

        async updatePostStatus(docId, postId, action) {
            // Actions: 'pin', 'lock'
            if (!db) return;
            // Find post
            const post = this.posts.find(p => p.id === postId);
            if (!post) return;
            
            try {
                const updates = {};
                if (action === 'pin') updates.isPinned = !post.isPinned;
                if (action === 'lock') updates.isLocked = !post.isLocked;
                
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'nanochan_posts', docId), updates);
            } catch(e) {
                alert("Error updating post: " + e.message);
            }
        }

        async deletePost(docId, postId, parentId) {
            if (!confirm(this.t('delete_confirm'))) return;
            if (useLocalStorage) {
                if (parentId === 0) this.posts = this.posts.filter(p => p.id !== postId && p.parentId !== postId);
                else this.posts = this.posts.filter(p => p.id !== postId);
                localStorage.setItem('pepechan_posts_v2', JSON.stringify(this.posts));
                this.render();
                if (this.view === 'thread' && this.currentThreadId === postId) this.goCatalog();
                return;
            }
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'nanochan_posts', docId));
                if (parentId === 0) {
                    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'nanochan_posts'), where("parentId", "==", postId));
                    const snapshot = await getDocs(q);
                    snapshot.forEach(async (d) => { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'nanochan_posts', d.id)); });
                }
                if (this.view === 'thread' && this.currentThreadId === postId) this.goCatalog();
            } catch (e) { alert("Error deleting"); }
        }

        switchBoard(boardCode) { this.currentBoard = boardCode; this.view = 'catalog'; this.currentThreadId = null; this.updateInterface(); this.render(); }
        goCatalog() { this.view = 'catalog'; this.currentThreadId = null; this.render(); }
        viewThread(threadId) { this.view = 'thread'; this.currentThreadId = threadId; this.render(); }

        compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800; 
                        const scaleSize = MAX_WIDTH / img.width;
                        if (scaleSize < 1) { canvas.width = MAX_WIDTH; canvas.height = img.height * scaleSize; } 
                        else { canvas.width = img.width; canvas.height = img.height; }
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7)); 
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        }

        async submitPost() {
            if (!useLocalStorage && !this.user) { alert(this.t('wait_conn')); return; }

            const nameIn = document.getElementById('input-name');
            const subIn = document.getElementById('input-subject');
            const comIn = document.getElementById('input-comment');
            const fileIn = document.getElementById('input-file');
            const fileUpload = document.getElementById('input-file-upload');
            const adminCheck = document.getElementById('admin-post-as-admin');

            let name = nameIn.value.trim();
            const subject = subIn.value.trim();
            const comment = comIn.value.trim();
            let file = fileIn.value.trim();

            if (fileUpload.files && fileUpload.files[0]) {
                try {
                    const uploadedFile = fileUpload.files[0];
                    if (uploadedFile.size > 2 * 1024 * 1024) { if(!confirm("–§–∞–π–ª > 2–ú–ë –±—É–¥–µ—Ç —Å–∂–∞—Ç. –û–ö?")) return; }
                    file = await this.compressImage(uploadedFile);
                } catch (e) { alert("–û—à–∏–±–∫–∞ —Ñ–æ—Ç–æ"); return; }
            }

            if (!comment && !file) { alert(this.t('validation_err')); return; }
            if (!this.isAdminMode && BANNED_NAMES.test(name)) { alert(this.t('name_banned')); return; }

            // Admin Logic
            const postAsAdmin = this.isAdminMode && adminCheck && adminCheck.checked;
            if (!name) name = postAsAdmin ? "Admin" : this.t('anon');

            // IP Fetch
            let userIp = "Hidden";
            if (!useLocalStorage) {
                try {
                    const res = await fetch('https://api.ipify.org?format=json');
                    const json = await res.json();
                    userIp = json.ip;
                } catch(e) {}
            }

            const postId = Date.now();
            const newPost = {
                id: postId,
                board: this.currentBoard,
                parentId: this.view === 'catalog' ? 0 : this.currentThreadId,
                name: name,
                subject: subject,
                comment: comment,
                file: file,
                date: new Date().toLocaleString(this.lang === 'ru' ? 'ru-RU' : 'en-US'),
                authorUid: useLocalStorage ? 'local' : this.user.uid,
                isAdmin: postAsAdmin,
                ip: userIp,
                isPinned: false,
                isLocked: false
            };

            if (useLocalStorage) {
                this.posts.push(newPost);
                localStorage.setItem('pepechan_posts_v2', JSON.stringify(this.posts));
                this.resetForm(subIn, comIn, fileIn, fileUpload);
                if (this.view === 'catalog') { this.view = 'thread'; this.currentThreadId = postId; }
                this.render(); return;
            }

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'nanochan_posts'), newPost);
                this.resetForm(subIn, comIn, fileIn, fileUpload);
                if (this.view === 'catalog') { this.view = 'thread'; this.currentThreadId = postId; }
            } catch (e) {
                if (e.code === 'resource-exhausted') alert("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (>1MB).");
                else alert(this.t('error_send'));
            }
        }

        resetForm(subIn, comIn, fileIn, fileUpload) { subIn.value = ''; comIn.value = ''; fileIn.value = ''; fileUpload.value = ''; }
        processText(text) { if (!text) return ''; let safe = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); return safe.split('\n').map(l => l.startsWith('&gt;') ? `<span class="greentext">${l}</span>` : l).join('<br>'); }
        toggleImage(img) { img.classList.toggle('expanded'); }
        insertId(id) { const t = document.getElementById('input-comment'); t.value += `>>${id}\n`; t.focus(); }
        
        stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            let color = '#';
            for (let i = 0; i < 3; i++) {
                let value = (hash >> (i * 8)) & 0xFF;
                color += ('00' + value.toString(16)).substr(-2);
            }
            return color;
        }

        render() {
            const formContainer = document.getElementById('post-form');
            const container = document.getElementById('main-content');
            this.renderAnnouncement();

            if (this.loading) { container.innerHTML = `<div class="loading-msg">${this.t('loading')}</div>`; return; }
            
            // Check Locked State
            let currentThread = null;
            if (this.view === 'thread') currentThread = this.posts.find(p => p.id === this.currentThreadId);
            
            if (this.view === 'catalog') {
                document.getElementById('form-type-label').textContent = this.t('new_thread');
                document.getElementById('nav-links').style.display = 'none';
                formContainer.style.display = 'table';
            } else {
                document.getElementById('form-type-label').textContent = `${this.t('reply_to')}${this.currentThreadId}`;
                document.getElementById('nav-links').style.display = 'block';
                // Hide form if locked
                if (currentThread && currentThread.isLocked) {
                    formContainer.style.display = 'none';
                    container.innerHTML = `<div style="text-align:center; color:red; font-weight:bold; margin-bottom:10px;">üîí ${this.t('thread_locked')}</div>`;
                } else {
                    formContainer.style.display = 'table';
                    container.innerHTML = '';
                }
            }

            const boardPosts = this.posts.filter(p => p.board === this.currentBoard);
            
            if (this.view === 'catalog') {
                // Sort: Pinned first, then by ID desc
                const threads = boardPosts.filter(p => p.parentId === 0).sort((a, b) => {
                    if (a.isPinned && !b.isPinned) return -1;
                    if (!a.isPinned && b.isPinned) return 1;
                    return b.id - a.id;
                });
                
                if (threads.length === 0) { container.innerHTML = `<div class="error-msg">${this.t('empty_board')}</div>`; return; }

                threads.forEach(op => {
                    const replies = boardPosts.filter(p => p.parentId === op.id);
                    const previewReplies = replies.slice(-3);
                    const threadDiv = document.createElement('div');
                    threadDiv.className = 'thread';
                    let html = this.renderPostHTML(op, true, true);
                    if (replies.length > 3) html += `<div style="color:#557755; margin-left: 20px; font-style: italic;">${this.t('omitted')}: ${replies.length - 3}. ${this.t('click_reply')}</div>`;
                    previewReplies.forEach(rep => html += this.renderPostHTML(rep, false, false));
                    threadDiv.innerHTML = html;
                    container.appendChild(threadDiv);
                });

            } else {
                if (!currentThread) { container.innerHTML = `<div class="error-msg">${this.t('thread_not_found')}</div>`; return; }
                const replies = boardPosts.filter(p => p.parentId === this.currentThreadId); // Sorted by ID asc naturally by Firebase fetch order usually, or we sort
                replies.sort((a,b) => a.id - b.id);
                
                const threadDiv = document.createElement('div');
                threadDiv.className = 'thread';
                let html = this.renderPostHTML(currentThread, true, false);
                replies.forEach(rep => html += this.renderPostHTML(rep, false, false));
                threadDiv.innerHTML = html;
                container.appendChild(threadDiv);
            }
        }

        renderPostHTML(post, isOp, isCatalog) {
            const formattedText = this.processText(post.comment);
            
            let imageHtml = '';
            if (post.file) {
                const isBase64 = post.file.startsWith('data:image');
                const hrefLink = isBase64 ? '#' : post.file;
                const linkAttr = isBase64 ? `onclick="window.app.toggleImage(this.parentElement.nextElementSibling); return false;"` : `target="_blank" rel="noopener noreferrer"`;
                const linkText = isBase64 ? '(–ö–∞—Ä—Ç–∏–Ω–∫–∞)' : this.t('link');
                imageHtml = `
                    <div class="file-info">${this.t('file')}: <a href="${hrefLink}" ${linkAttr}>${linkText}</a></div>
                    <img src="${post.file}" class="post-image" referrerpolicy="no-referrer" onclick="window.app.toggleImage(this)" 
                         onerror="this.onerror=null; this.src='https://placehold.co/200?text=Error'; this.style.border='1px solid red';">
                `;
            }

            // Name Logic
            let nameDisplay = post.name;
            const nameClass = post.isAdmin ? "name admin-capcode" : "name";
            if (!post.isAdmin && (nameDisplay === '–ê–Ω–æ–Ω–∏–º' || nameDisplay === 'Anonymous')) nameDisplay = this.t('anon');
            if (post.isAdmin) {
                if (nameDisplay === 'Admin') nameDisplay = "# Admin #";
                else nameDisplay = `${nameDisplay} ## Admin`;
            }

            // Status Icons
            let icons = "";
            if (isOp) {
                if (post.isPinned) icons += `<span class="pinned-icon">üìå</span>`;
                if (post.isLocked) icons += `<span class="locked-icon">üîí</span>`;
            }

            // Admin Controls
            let adminControls = '';
            if (this.isAdminMode) {
                // Meta Info (IDs)
                if (this.showAdminMeta) {
                    const color = this.stringToColor(post.authorUid);
                    adminControls += `<span class="admin-meta-info" style="background:${color}">UID: ${post.authorUid.slice(0,5)}..</span>`;
                    adminControls += `<span class="admin-meta-info">IP: ${post.ip || '?'}</span>`;
                }
                // Buttons
                const docId = post._docId || '';
                if (isOp && docId) {
                    adminControls += `<span class="admin-btn btn-pin" onclick="window.app.updatePostStatus('${docId}', ${post.id}, 'pin')">[Pin]</span>`;
                    adminControls += `<span class="admin-btn btn-lock" onclick="window.app.updatePostStatus('${docId}', ${post.id}, 'lock')">[Lock]</span>`;
                }
                if (docId) {
                    adminControls += `<span class="admin-btn btn-del" onclick="window.app.deletePost('${docId}', ${post.id}, ${post.parentId})">[Del]</span>`;
                }
            }

            const headerHtml = `
                ${icons} <span class="subject">${post.subject || ''}</span> 
                <span class="${nameClass}">${nameDisplay}</span> 
                <span class="date">${post.date}</span>
                <span class="post-number">No.</span><span class="id" onclick="window.app.insertId(${post.id})">${post.id}</span>
                ${adminControls}
                ${isOp && isCatalog && !post.isLocked ? `[<a href="#" onclick="window.app.viewThread(${post.id}); return false;">${this.t('reply_btn')}</a>]` : ''}
            `;

            if (isOp) {
                return `<div class="post op-post" id="post-${post.id}">${imageHtml}<div class="post-header">${headerHtml}</div><div class="post-message">${formattedText}</div></div><div style="clear:both"></div>`;
            } else {
                return `<div class="reply-container" id="post-${post.id}"><div class="post-header">${headerHtml}</div>${imageHtml}<div class="post-message">${formattedText}</div></div>`;
            }
        }
    }

    window.app = new ImageboardApp();
</script>
</body>
</html>